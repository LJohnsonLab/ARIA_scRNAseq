---
title: "Differences in microglia by sample & treatment"
subtitle: ""
date: today
embed-resources: true
execute: 
  warning: false
  echo: false
editor_options: 
  chunk_output_type: console
---

```{r}

library(tidyverse)
library(Seurat)
library(patchwork)
library(kableExtra)
library(compareGroups)
library(corrplot)
library(pheatmap)

# load the previously saved reclustered object 
load("data/20250818-microglia_reclustered_reintegrated.Rdata")

```
## Proportions (%) of Microglial States Across Samples and Treatments

```{r}
#| column: page
#| fig-width: 12
#| 
DimPlot(microglia, label = TRUE, repel = TRUE, label.size = 7,
        split.by = "Treatment.Group") +
    NoLegend()
```


```{r}

# Reference table mapping each sample ID to its treatment type
sample_index <- microglia@meta.data |> 
    # Keep only unique combinations of sample ID (orig.ident) and treatment group (type)
    distinct(Mouse.ID, Treatment.Group)   


# Table of cluster composition per sample, convert counts to percentages, and add treatment info
cell <- microglia@meta.data |> 
    # Group cells by sample and Seurat cluster
    group_by(Mouse.ID, final_clusters) |> 
    # Count number of cells in each (sample, cluster) combination
    summarize(n = n()) |> 
    # Reshape so that sample IDs become columns and values are cell counts
    pivot_wider(names_from = Mouse.ID, values_from = n) |> 
    # For all columns except 'final_clusters', convert counts to percentages per cluster
    mutate(across(-final_clusters, \(x) round(x / sum(x) * 100, 1))) |> 
    # Make the 'final_clusters' column the row names
    column_to_rownames("final_clusters") |> 
    # Transpose so that samples are rows and clusters are columns
    t() |> 
    # Convert the matrix back into a standard data frame
    as.data.frame() |> 
    # Turn row names (sample IDs) into a column
    rownames_to_column(var = "Mouse.ID") |> 
    # Join treatment type information from 'sample_index'
    inner_join(sample_index, by = "Mouse.ID")
```



Relative abundance of each microglial Seurat-defined cluster in individual samples and compared proportions between the Aducanumab-treated and IgG control groups.\

```{r}
#| column: page
#| fig-width: 12
cell_longer <- cell |> 
    pivot_longer(`0`:`9`, names_to = "cluster") |> 
    mutate(cluster = fct_inseq(cluster))

ggplot(cell_longer,aes(x= Mouse.ID, y = value, fill = cluster))+
    geom_col()+
    labs(y = "%")+
    facet_wrap( ~Treatment.Group)+
    theme_minimal()+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.y = element_text(size=16),
          axis.text.y = element_text(size=14),
          strip.text = element_text(size=20))
    

```

------------------------------------------------------------------------

```{r}
# Compare all variables in 'cell' across treatment groups using compareGroups
c1 <- compareGroups(Treatment.Group ~.-Mouse.ID, cell, method = 2)
t1 <- createTable(c1)
export2md(t1, caption = "")
```

Values are median % of microglia in that cluster per sample, with IQR.\
p.overall: Mann-Whitney p-value

## Pseudobulk analysis: _Aducanumab vs. IgG_



```{r}
#| eval: false
pseudo <- AggregateExpression(microglia, assays = "RNA",
                              group.by = c("Mouse.ID","final_clusters","Treatment.Group"),
                              return.seurat = T)

pseudo$pseudobulk_id = paste("cluster",pseudo$final_clusters,pseudo$Treatment.Group,sep="_")

Idents(pseudo) <- "pseudobulk_id"
```

```{r}

pseudo <- AggregateExpression(microglia, assays = "RNA",
                              group.by = c("Mouse.ID","Treatment.Group"),
                              return.seurat = T)



Idents(pseudo) <- "Treatment.Group"
```


```{r}

bulk_0 <- FindMarkers(pseudo,
                      ident.1 ="Adu",
                      ident.2 = "IgG",
                      test.use = "DESeq2")


bulk_0_top <- bulk_0 |> 
    filter(p_val_adj<0.05)

kbl(bulk_0_top) |> 
    kable_styling("striped")
```



Following treatment, microglia from the Alzheimer’s disease mouse model exhibited a broad transcriptional shift consistent with reduced pro-inflammatory activation and metabolic demand. Several mitochondrial genes (*mt-Nd4l*, *mt-Atp8*) and the amino acid transporter *Slc38a2* were downregulated, suggesting diminished oxidative phosphorylation and nutrient uptake that normally support highly activated microglial states. Key inflammatory mediators, including *Il1a*, *Cxcl1*, *Tnfaip2*, and the microRNA host gene *Mir155hg*, also decreased, indicating attenuation of cytokine release, chemotactic signaling, NF-κB pathway activity, and miR-155–driven immune activation. Concomitant reductions in *Prdm1* and regulatory non-coding transcripts (*Gm13849*, *C430049B03Rik*), together with decreased *Rpl35* and *Man1a*, point to lower transcriptional activity, protein synthesis, and secretory function, while the decline in *H2ac20* implies chromatin remodeling toward a less plastic state. Notably, this general dampening of inflammatory pathways was accompanied by increased expression of *Ccl7*, a chemokine involved in monocyte recruitment. This suggests that while most pro-inflammatory signals were suppressed, the treatment selectively maintained or enhanced pathways favoring controlled immune cell trafficking, potentially reflecting a rebalancing of microglial responses rather than their complete silencing. Collectively, these findings support the notion that the treatment shifts microglia away from a broadly activated phenotype toward a more homeostatic yet immunologically competent state, which may contribute to mitigation of chronic neuroinflammation in Alzheimer’s disease.




