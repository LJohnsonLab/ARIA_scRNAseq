---
title: "Differences in microglia by sample & treatment"
subtitle: ""
date: today
dpi: 300
embed-resources: true
execute: 
  warning: false
  echo: false
editor_options: 
  chunk_output_type: console
---

```{r}

library(tidyverse)
library(Seurat)
library(scCustomize) # https://samuel-marsh.github.io/scCustomize/
library(patchwork)
library(kableExtra)
library(compareGroups)
library(pheatmap)

# load the previously saved reclustered object 
load("data/20250818-microglia_reclustered_reintegrated.Rdata")
microglia <- subset(microglia, idents = "8", invert =T)


new_cluster_names <- c(
  "NFkB/IEG Activated",
  "Homeostatic (Activation competent)",
  "DAM (Early/Intermediate)",
  "Remodeling / Injury response",
  "Homeostatic (canonical)",
  "DAM (late)",
  "Antigen presenting",
  "Interferon responsive",
  "Proliferating"
)

microglia <- Rename_Clusters(microglia,
                new_ident_name = "final_clusters_clean",
                new_idents = new_cluster_names,
                overwrite = T)




```

## Total microglia states

Uniform Manifold Approximation and Projection (UMAP) visualization of `r ncol(microglia)` microglial cells.

Each point represents a single cell, and cells are colored according to unsupervised clusters identified from transcriptomic profiles.

```{r}
#| column: page
#| fig-width: 12

#############################################################################
### UMAP
#############################################################################
DimPlot(microglia, label = F) +
    scale_colour_brewer(palette = "Paired")+
    labs(title = "Microglia States") +
    theme(plot.title = element_text(size=16, hjust = 0.5))+
    NoAxes()
```


## Total cells

Bar plot showing the number of cells assigned to each cluster.

```{r}
## helper functions
source("20250725-helper_functions.R")
# use scProp_help()

microglia_prop <- scProp(microglia,
                         cluster_col = "final_clusters_clean",
                         sample_col = 'Mouse.ID',
                         treatment_col = "Treatment.Group")
```

```{r}
microglia_prop$counts_plot
```

## Gene Heatmap & hierarchical cluster

Heatmap of normalized expression levels for representative marker genes across clusters, with hierarchical clustering applied to both genes and clusters, providing an overview of the molecular signatures that distinguish microglial states.

```{r}
#| column: page
#| fig-width: 12
#############################################################################
####### Heatmap & hierarchical cluster
#############################################################################

markers_microglia_clean <- FindAllMarkers(microglia, min.pct = 0.3,
                                     only.pos = F, densify = TRUE)


feat <- markers_microglia_clean|>  
    filter(pct.1 > 0.3) |> 
    arrange(cluster, p_val_adj) |> 
    group_by(cluster) |> 
    slice_head(n = 5)|> 
    pull(unique(gene))


# When return.seurat = TRUE and layer is 'scale.data', the 'counts' layer contains
# average counts and 'scale.data' is set to the averaged values of 'scale.data'.
avg_expression <- AverageExpression( microglia,
  assays = "SCT", 
  layer = "scale.data", 
  group.by = "final_clusters_clean",
  return.seurat = T
)




data4cluster <- FetchData(avg_expression,c(feat,"P2ry12","Tmem119"), layer = "scale.data") |> 
    mutate(across(everything(), \(x) ifelse(x>9,9,x)))
           



    
pheatmap(data4cluster,
         color = colorRampPalette(c("blue", "white", "yellow","orange" ,"red"))(100),
          cellwidth = 12, cellheight = 10,
          angle_col = 45, row.names=T) 
 


```

## Proportions (%) of Microglial States Across Samples and Treatments

```{r}
#| fig-width: 10
#| fig-height: 4
microglia_prop$proportions_plot
```

Stacked barplot of the relative abundance of each microglial Seurat-defined cluster in individual samples and compared proportions between the Aducanumab-treated and IgG control groups.\

------------------------------------------------------------------------

```{r}
# Compare all variables in 'cell' across treatment groups using compareGroups
export2md(microglia_prop$summary_table, caption = "")
```

Values are median % of microglia in that cluster per sample, with IQR.\
p.overall: Mann-Whitney p-value



## Module scores

UMAP displaying the combined expression scores or the distribution of individual canonical microglial marker genes, illustrating the transcriptional features that define each cluster.

```{r}


# Signatures for microglia subtypes
source("data/microglia_signatures.R")  
signatures$TIM <- c("Klf4","Malat1","Tmx4","Jund","Btg2","Fasb","Jun","Fos","Klf2")
signatures$Homeostatic <- c("P2ry12","P2ry13","Cx3cr1","Maf","Frmd4a","Csf1r","Tmem119")
signatures$AP <- c("Cp", "H2-Eb1","H2-Ab1","H2-Aa","Cd74","B2m","Cd37")

DefaultAssay(microglia) <- "SCT"


sig_names <- names(signatures)

#  keep only genes present in your object to avoid warnings
signatures <- lapply(signatures, function(g) intersect(g, rownames(microglia)))

# Score: 'name' is a single prefix (Seurat appends 1..N)
microglia <- AddModuleScore(
  object   = microglia,
  features = signatures,
  name     = "Sig",   # one prefix, not a vector
  nbin     = 24,
  ctrl     = 100,
  seed     = 1
)

# Rename the last N columns to "<Signature>_Score"
n_new  <- length(signatures)
idx    <- (ncol(microglia@meta.data) - n_new + 1):ncol(microglia@meta.data)
colnames(microglia@meta.data)[idx] <- paste0(sig_names, " Score")
```

Markers from bibliography to generate the scores

```{r}
df_long <- imap_dfr(signatures, ~ tibble(Signature = .y, Gene = .x)) |> 
    group_by(Signature) |> 
    summarize(genes = paste(Gene, collapse=", ")) |> 
    filter(Signature%in%c("DAM","IRM","IEG","TIM","AP","Homeostatic"))
    

kbl(df_long) |>
  kable_styling("striped")
```

```{r}
#| column: screen
#| fig-width: 15
#| fig-height: 4

signature_plot <- FeaturePlot(microglia, features = c("DAM Score" ,"IRM Score","IEG Score",
                                                      "TIM Score","Homeostatic Score","AP Score"),
            min.cutoff = "q20", cols = c( "grey96","red"),
            split.by = "Treatment.Group",
            combine = F) |> 
    map(\(x) x+ NoAxes()+NoLegend()+ 
            theme(plot.title = element_text(size = 12, vjust = 0),
                  panel.border = element_blank()))

wrap_plots(signature_plot, nrow = 2)
```

IRM : Interferon-response microglia.\
IEG : Intermediate early Gene-enriched  
TIM : Terminally inflammatory microglia [@millet2024]  
AP : Antigen Presenting
