---
title: "Microglial subpopulations x sample"
date: today
toc-depth: 4
embed-resources: true
execute: 
  warning: false
  echo: false
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r}
library(tidyverse)
library(Seurat)
library(patchwork)
library(kableExtra)
library(compareGroups)

load("data/20250809-microglia1.Rdata")
```

## Cluster summary



| Cluster | Likely Cell Type / State                              |
|---------|-------------------------------------------------------|
| 0       | Inflammatory / NF-κB–Driven Microglia                                 |
| 1       | Resolution / Repair-Oriented Microglia                   |
| 2       | Hypoxia-Adapted / Phagocytic (clearance) Microglia          |
| 4       | Homeostatic microglia                   |
| 6       | DAM-like / interferon-response microglia              |
| 8       | Early-Activation / Primed Microglia         |
| 10      | DAM / oxidative stress microglia                      |
| 12      | Homeostatic or early-activated microglia. Includes motility/migration genes |
| 14      | DAM-like subset / phagocytic microglia                |
| 15      | T cells                                               |
| 17      | Mixed/garbage cluster                                 |
| 22      | Border-associated macrophages (BAMs)/activated microglia.                                 |
| 23      | Vascular-associated cells (pericytes/endothelial)     |
| 27      | Proliferating Microglia                                   |

```{r}
DimPlot(microglia, label = TRUE, repel = T, label.size = 9) + 
    NoLegend() + NoAxes()
```




_Consider merging clusters 6/10/14. All seem DAM with 2 in hypoxia- and lysosome-enriched myeloid state, 10 skewing towards oxidative stress (Hmox1/Nqo1) and 14 more phagocytic/clearance (Clec7a/Axl) >>> those differences should appear when we do the DE pseudobulk._


```{r}

# Reference table mapping each sample ID to its treatment type
sample_index <- microglia@meta.data |> 
    # Keep only unique combinations of sample ID (orig.ident) and treatment group (type)
    distinct(orig.ident, type)   


# Table of cluster composition per sample, convert counts to percentages, and add treatment info
cell <- microglia@meta.data |> 
    # Group cells by sample and Seurat cluster
    group_by(orig.ident, seurat_clusters) |> 
    # Count number of cells in each (sample, cluster) combination
    summarize(n = n()) |> 
    # Reshape so that sample IDs become columns and values are cell counts
    pivot_wider(names_from = orig.ident, values_from = n) |> 
    # Remove clusters 17 and 23 (e.g., garbage/mixed and vascular-associated cells)
    filter(!seurat_clusters %in% c(15,17, 23)) |> 
    # For all columns except 'seurat_clusters', convert counts to percentages per cluster
    mutate(across(-seurat_clusters, \(x) round(x / sum(x) * 100, 1))) |> 
    # Make the 'seurat_clusters' column the row names
    column_to_rownames("seurat_clusters") |> 
    # Transpose so that samples are rows and clusters are columns
    t() |> 
    # Convert the matrix back into a standard data frame
    as.data.frame() |> 
    # Turn row names (sample IDs) into a column
    rownames_to_column(var = "orig.ident") |> 
    # Join treatment type information from 'sample_index'
    inner_join(sample_index, by = "orig.ident")
```




## Cluster-by-cluster comparison

Relative abundance of each microglial Seurat-defined cluster in individual samples and compared proportions between the Aducanumab-treated and IgG control groups.\
For each mouse, the percentage of cells in a given cluster was calculated after excluding clusters identified as mixed/garbage (cluster 17), T-cells (cluster 15) or vascular-associated (cluster 23)

```{r}
#| column: page
#| fig-width: 12
cell_longer <- cell |> 
    pivot_longer(`0`:`27`, names_to = "cluster") |> 
    mutate(cluster = fct_inseq(cluster))

ggplot(cell_longer,aes(x= orig.ident, y = value, fill = cluster))+
    geom_col()+
    labs(y = "%")+
    facet_wrap( ~type)+
    theme_minimal()+
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.y = element_text(size=16),
          axis.text.y = element_text(size=14),
          strip.text = element_text(size=20))
    

```

---

```{r}
# Compare all variables in 'cell' across treatment groups using compareGroups
c1 <- compareGroups(type ~.-orig.ident, cell, method = 2)
t1 <- createTable(c1)
export2md(t1, caption = "")
```

Values are median % of microglia in that cluster per sample, with IQR.\
p.overall: Mann-Whitney p-value 

---



