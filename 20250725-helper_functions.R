### ggplot decoration for the density plots
density_decor <- function(x){
    list(
        geom_density(),
        theme_minimal(),
        theme(axis.text.y = element_blank(),
              axis.text.x = element_text(size=12),
              axis.title.x = element_text(size=14))
    )
}    
######################################################################################################
############################### FIDDLE ###############################################################    
######################################################################################################

# Load libraries only if not already loaded
if (!require(ggplot2, quietly = TRUE)) library(ggplot2)
if (!require(dplyr, quietly = TRUE)) library(dplyr)
if (!require(tidyr, quietly = TRUE)) library(tidyr)
if (!require(forcats, quietly = TRUE)) library(forcats)
if (!require(purrr, quietly = TRUE)) library(purrr)
if (!require(ggtext, quietly = TRUE)) library(ggtext)
if (!require(grid, quietly = TRUE)) library(grid)
if (!require(scales, quietly = TRUE)) library(scales)

#' Create a multi-faceted violin plot with colored axis labels
#'
#' @param seurat_obj Seurat object containing the data
#' @param genes_of_interest Character vector of gene names to plot
#' @param classification_col Character string specifying the column name for classification
#' @param assay Character string specifying which assay to use (default: "RNA")
#' @param axis_text_y_size Numeric, size of y-axis text (default: 12)
#' @param axis_text_x_size Numeric, size of x-axis text (default: 6)
#' @param strip_text_size Numeric, size of facet strip text (default: 11)
#' @param violin_scale Character, scaling method for violins (default: "width")
#' @param violin_trim Logical, whether to trim violin tails (default: TRUE)
#' @param violin_adjust Numeric, bandwidth adjustment for violins (default: 1)
#' @param facet_nrow Numeric, number of rows for facet_wrap (default: 1)
#'
#' @return A list containing the ggplot object (p) and the modified grob (g)
#' @export
fiddle <- function(seurat_obj, 
                   genes_of_interest,
                   classification_col,
                   assay = "RNA",
                   axis_text_y_size = 12,
                   axis_text_x_size = 6,
                   strip_text_size = 11,
                   violin_scale = "width",
                   violin_trim = TRUE,
                   violin_adjust = 1,
                   facet_nrow = 1) {
    
    # Validate inputs
    if (!classification_col %in% colnames(seurat_obj@meta.data)) {
        stop(paste("Classification column", classification_col, "not found in Seurat object metadata"))
    }
    
    # Fetch data from Seurat object
    violin_data <- FetchData(seurat_obj, c(genes_of_interest, classification_col), assay = assay)
    
    # Reshape data to long format
    violin_data_long <- violin_data %>%
        pivot_longer(-all_of(classification_col)) %>% 
        mutate(seurat_clusters = fct_rev(.data[[classification_col]]),
               name = factor(name, levels = genes_of_interest))
    
    # Generate color palette
    cluster_levels <- levels(violin_data_long$seurat_clusters)
    palette_colors <- scales::hue_pal()(length(cluster_levels))
    names(palette_colors) <- cluster_levels
    
    # Create colored axis labels (HTML span with color)
    axis_labels <- purrr::map2_chr(cluster_levels, palette_colors,
                                   ~sprintf("<span style='color:%s'>%s</span>", .y, .x))
    
    # Create the base plot
    p <- ggplot(violin_data_long, aes(x = seurat_clusters, y = value, fill = seurat_clusters)) +
        geom_violin(aes(color = seurat_clusters),
                    scale = violin_scale, 
                    trim = violin_trim, 
                    adjust = violin_adjust, 
                    show.legend = FALSE) +
        coord_flip() +
        scale_fill_manual(values = palette_colors) +
        scale_color_manual(values = palette_colors) +
        facet_wrap(~name, scales = "free_x", nrow = facet_nrow) +
        theme_minimal() +
        labs(x = "", y = "") +
        theme(
            legend.position = "left",
            axis.text.y = element_markdown(size = axis_text_y_size),
            axis.text.x = element_text(size = axis_text_x_size),
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank(),
            strip.text = element_text(size = strip_text_size, face = "italic")
        ) +
        scale_x_discrete(labels = axis_labels)
    
    # Convert ggplot object to grob (graphical object)
    g <- ggplotGrob(p)
    
    # Find all the left axis grobs (y-axis elements)
    axis_grobs <- which(grepl("axis-l", g$layout$name))
    
    # Remove y-axis text from all but the first facet
    invisible(
        map(axis_grobs, function(i) {
            # The first facet left axis is named 'axis-l-1-1'
            if (g$layout[i, "name"] != "axis-l-1-1") {
                g$grobs[[i]] <<- nullGrob()
            }
        })
    )
    
    # Display the plot
    grid.newpage()
    grid.draw(g)
}


######################################################################################################
# Help function
fiddle_help <- function() {
    cat("fiddle() - Create a multi-faceted violin plot with colored axis labels\n\n")
    cat("Usage:\n")
    cat("  fiddle(seurat_obj, genes_of_interest, classification_col, ...)\n\n")
    cat("Required Parameters:\n")
    cat("  seurat_obj         - Seurat object containing the data\n")
    cat("  genes_of_interest  - Character vector of gene names to plot\n")
    cat("  classification_col - Column name for classification (no default)\n\n")
    cat("Optional Parameters:\n")
    cat("  assay             - Assay to use (default: 'RNA')\n")
    cat("  axis_text_y_size  - Y-axis text size (default: 12)\n")
    cat("  axis_text_x_size  - X-axis text size (default: 6)\n")
    cat("  strip_text_size   - Facet strip text size (default: 11)\n")
    cat("  violin_scale      - Violin scaling method (default: 'width')\n")
    cat("  violin_trim       - Trim violin tails (default: TRUE)\n")
    cat("  violin_adjust     - Bandwidth adjustment (default: 1)\n")
    cat("  facet_nrow        - Number of facet rows (default: 1)\n\n")
    cat("Returns: List with plot, grob, and colors\n\n")
    cat("Example:\n")
    cat("  result <- fiddle(aria, c('Gene1', 'Gene2'), 'lance_classification')\n")
}

# Example usage:
# result <- fiddle(
#   seurat_obj = aria,
#   genes_of_interest = c("Gene1", "Gene2", "Gene3"),
#   classification_col = "lance_classification"
# )
# 
# # For help, run:
# fiddle_help()
######################################################################################################


#' Perform Differential Expression Analysis with Visualization
#'
#' This function performs differential expression analysis between two cell populations
#' using Seurat's FindMarkers function and creates a volcano plot visualization. The function
#' automatically calculates appropriate x-axis limits based on the data range and provides
#' both tabular and visual outputs.
#'
#' @param seurat_obj A Seurat object containing single-cell RNA-seq data
#' @param ident1 Character string specifying the first identity group for comparison
#' @param ident2 Character string specifying the second identity group for comparison
#' @param min_pct Numeric value specifying the minimum percentage of cells expressing 
#'   a gene in either group (default: 0.3)
#' @param test_method Character string specifying the statistical test to use 
#'   (default: "DESeq2"). Other options include "wilcox", "t", "negbinom", etc.
#' @param p_adj_threshold Numeric value for adjusted p-value threshold for significance 
#'   (default: 0.05)
#' @param fc_cutoff Numeric value for fold change cutoff in volcano plot (default: 0.001)
#' @param plot_title Character string for the main title prefix 
#'   (default: "Differentially expressed genes")
#'
#' @return A list containing:
#' \describe{
#'   \item{all_results}{Data frame with all differential expression results}
#'   \item{significant_results}{Data frame with only significant results (p_adj < threshold)}
#'   \item{volcano_plot}{EnhancedVolcano plot object}
#'   \item{xlim_used}{Numeric vector of x-axis limits used in the plot}
#'   \item{summary}{List with summary statistics including total genes, significant genes, and comparison info}
#' }
#'
#' @details
#' The function performs the following steps:
#' \enumerate{
#'   \item Loads required packages (dplyr, EnhancedVolcano) if not already loaded
#'   \item Runs differential expression analysis using Seurat's FindMarkers
#'   \item Filters results for statistical significance
#'   \item Calculates appropriate x-axis limits based on log2 fold change range
#'   \item Generates an enhanced volcano plot with automatic labeling
#'   \item Returns comprehensive results for further analysis
#' }
#'
#' The volcano plot automatically sets x-axis limits to integer values that encompass
#' the full range of log2 fold changes in the data, ensuring all points are visible.
#'
#' @examples
#' \dontrun{
#' # Basic usage with default parameters
#' results <- anayet(seurat_object, 
#'                   ident1 = "Astrocytes_Adu", 
#'                   ident2 = "Astrocytes_IgG")
#'
#' # Custom parameters
#' results <- anayet(seurat_object,
#'                   ident1 = "Neurons_Treated", 
#'                   ident2 = "Neurons_Control",
#'                   min_pct = 0.25,
#'                   test_method = "wilcox",
#'                   p_adj_threshold = 0.01,
#'                   plot_title = "Top DEGs")
#'
#' # Access results
#' significant_genes <- results$significant_results
#' volcano_plot <- results$volcano_plot
#' print(results$summary)
#' }
#'
#' @seealso 
#' \code{\link[Seurat]{FindMarkers}} for the underlying differential expression analysis
#' \code{\link[EnhancedVolcano]{EnhancedVolcano}} for volcano plot creation
#' \code{\link{anayet_help}} for detailed help and examples
#'
#' @import dplyr
#' @import EnhancedVolcano
#' @export
anayet <- function(seurat_obj, 
                   ident1, 
                   ident2, 
                   min_pct = 0.3, 
                   test_method = "DESeq2",
                   p_adj_threshold = 0.05,
                   fc_cutoff = 0.001,
                   plot_title = "Differentially expressed genes") {
    
    # Load required packages if not already loaded
    if (!require(dplyr, quietly = TRUE)) library(dplyr)
    if (!require(EnhancedVolcano, quietly = TRUE)) library(EnhancedVolcano)
    
    # Perform differential expression analysis
    de_results <- FindMarkers(seurat_obj,
                              min.pct = min_pct,
                              ident.1 = ident1,
                              ident.2 = ident2,
                              test.use = test_method)
    
    # Filter significant results
    de_results_significant <- de_results |> 
        filter(p_val_adj < p_adj_threshold)
    
    # Calculate xlim based on data range
    fc_range <- range(de_results$avg_log2FC, na.rm = TRUE)
    xlim_lower <- floor(fc_range[1])
    xlim_upper <- ceiling(fc_range[2])
    
    # Extract cell type from ident1 for automatic subtitle generation
    cell_type <- gsub("_.*", "", ident1)
    condition1 <- gsub(".*_", "", ident1)
    condition2 <- gsub(".*_", "", ident2)
    
    # Create full title
    full_title <- paste(plot_title, "in", cell_type)
    
    # Create volcano plot
    volcano_plot <- EnhancedVolcano(de_results,
                                    lab = rownames(de_results),
                                    x = 'avg_log2FC',
                                    y = 'p_val',
                                    title = full_title,
                                    labFace = "italic",
                                    caption = "",
                                    subtitle = paste(condition1, "vs.", condition2),
                                    FCcutoff = fc_cutoff,
                                    legendPosition = 'no',
                                    drawConnectors = TRUE,
                                    directionConnectors = "both",
                                    max.overlaps = Inf,
                                    xlim = c(xlim_lower, xlim_upper))
    
    # Display the plot
    print(volcano_plot)
    
    # Return results
    return(list(
        all_results = de_results,
        significant_results = de_results_significant,
        volcano_plot = volcano_plot,
        xlim_used = c(xlim_lower, xlim_upper),
        summary = list(
            total_genes = nrow(de_results),
            significant_genes = nrow(de_results_significant),
            comparison = paste(ident1, "vs", ident2)
        )
    ))
}

#### anayet help


#' Display Help Information for the anayet Function
#'
#' This function provides comprehensive help and usage information for the anayet
#' differential expression analysis function. It explains the purpose, parameters,
#' outputs, and provides practical examples.
#'
#' @return NULL (prints help information to console)
#' @export
#' @examples
#' anayet_help()
anayet_help <- function() {
    cat("==========================================================================\n")
    cat("                           ANAYET FUNCTION HELP\n")
    cat("==========================================================================\n\n")
    
    cat("PURPOSE:\n")
    cat("--------\n")
    cat("The anayet() function performs differential expression analysis between two\n")
    cat("cell populations using Seurat and creates publication-ready volcano plots.\n\n")
    
    cat("BASIC USAGE:\n")
    cat("------------\n")
    cat("results <- anayet(seurat_obj, ident1, ident2)\n\n")
    
    cat("REQUIRED PARAMETERS:\n")
    cat("-------------------\n")
    cat("seurat_obj  : Your Seurat object containing single-cell data\n")
    cat("ident1      : First identity group for comparison (e.g., 'Astrocytes_Treated')\n")
    cat("ident2      : Second identity group for comparison (e.g., 'Astrocytes_Control')\n\n")
    
    cat("OPTIONAL PARAMETERS (with defaults):\n")
    cat("------------------------------------\n")
    cat("min_pct = 0.3           : Minimum % of cells expressing a gene\n")
    cat("test_method = 'DESeq2'  : Statistical test ('DESeq2', 'wilcox', 't', etc.)\n")
    cat("p_adj_threshold = 0.05  : Adjusted p-value cutoff for significance\n")
    cat("fc_cutoff = 0.001       : Fold change threshold for volcano plot\n")
    cat("plot_title = 'Differentially expressed genes' : Title prefix for plot\n\n")
    
    cat("WHAT THE FUNCTION DOES:\n")
    cat("----------------------\n")
    cat("1. Loads required packages automatically\n")
    cat("2. Runs differential expression analysis\n")
    cat("3. Filters for statistically significant genes\n")
    cat("4. Calculates appropriate x-axis limits for visualization\n")
    cat("5. Generates a volcano plot with automatic x-axis scaling\n")
    cat("6. Returns comprehensive results for further analysis\n\n")
    
    cat("OUTPUT:\n")
    cat("-------\n")
    cat("The function returns a list containing:\n")
    cat("$all_results        : Complete DE analysis results\n")
    cat("$significant_results: Only significant genes (p_adj < threshold)\n")
    cat("$volcano_plot       : EnhancedVolcano plot object\n")
    cat("$xlim_used         : X-axis limits used in the plot\n")
    cat("$summary           : Summary statistics\n\n")
    
    cat("EXAMPLES:\n")
    cat("---------\n")
    cat("# Basic analysis\n")
    cat("results <- anayet(my_seurat, 'Neurons_KO', 'Neurons_WT')\n\n")
    
    cat("# With custom parameters\n")
    cat("results <- anayet(my_seurat, 'Astrocytes_Treated', 'Astrocytes_Control',\n")
    cat("                  min_pct = 0.25, test_method = 'wilcox', \n")
    cat("                  p_adj_threshold = 0.01, plot_title = 'Top DEGs')\n\n")
    
    cat("# Access specific results\n")
    cat("top_genes <- results$significant_results\n")
    cat("plot <- results$volcano_plot\n")
    cat("print(results$summary)\n\n")
    
    cat("REQUIRED PACKAGES:\n")
    cat("-----------------\n")
    cat("The function will automatically load: dplyr, EnhancedVolcano\n")
    cat("Make sure Seurat is also installed and loaded in your environment.\n\n")
    
    cat("TIPS:\n")
    cat("-----\n")
    cat("- Use descriptive identity names (e.g., 'CellType_Condition')\n")
    cat("- Adjust min_pct for sparse datasets (lower values for rare cell types)\n")
    cat("- Use 'wilcox' test for faster analysis with large datasets\n")
    cat("- The volcano plot x-axis automatically scales to your data range\n\n")
    
    cat("==========================================================================\n")
}
